version: "3.1"
services:
  db:
    build:
      context: ./db
    image: cryptogram/db
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${PG_SU_PASSWORD}
      - PG_WRITER_PASSWORD=${PG_WRITER_PASSWORD}
      - PG_READER_PASSWORD=${PG_READER_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/postgresql.conf:/etc/postgresql/postgresql.conf
    networks:
      - cryptogram
    shm_size: '256m'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 1m
      timeout: 5s
      retries: 5
    ports:
      - 127.0.0.1:5432:5432
    stop_signal: SIGINT
    stop_grace_period: 1m
    restart: unless-stopped

  redis-sessions:
    image: redis:6.2.7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 2GB --save ""
    networks:
      - cryptogram
    restart: unless-stopped

  redis-socketio:
    image: redis:6.2.7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 2GB --save ""
    networks:
      - cryptogram
    restart: unless-stopped

  redis-data:
    image: redis:6.2.7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 2GB --save ""
    networks:
      - cryptogram
    restart: unless-stopped

  redis-blockscout:
    image: redis:6.2.7-alpine
    command: redis-server --maxmemory 2GB --save ""
    networks:
      - cryptogram
    restart: unless-stopped

  wsapi:
    image: cryptogram/backend
    environment:
      - DB_TYPE=writer
      - PG_PASSWORD=${PG_WRITER_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SECRET=${REDIS_SECRET}
      - DEPLOYMENT=${DEPLOYMENT}
      - BASE_URL=${BASE_URL}
      - CGID_URL=${BASE_URL}/index_cgid.html
      - LOCAL_CERTIFICATE_IP=${LOCAL_CERTIFICATE_IP}
    depends_on:
      - db
      - redis-sessions
      - redis-socketio
      - redis-data
    networks:
      - cryptogram
    command: ["node", "/dist/wsapi.js"]
    stop_grace_period: 1m
    restart: unless-stopped

  seaweedmaster:
    image: chrislusf/seaweedfs
    command: "master -ip=seaweedmaster -volumeSizeLimitMB=16"
    restart: unless-stopped
    networks:
      - cryptogram
    environment:
      WEED_MASTER_VOLUME_GROWTH_COPY_1: 1
      WEED_MASTER_VOLUME_GROWTH_COPY_OTHER: 1
  
  seaweedvolume:
    image: chrislusf/seaweedfs
    command: "volume -mserver=seaweedmaster:9333 -port=8080 -ip=seaweedvolume -preStopSeconds=1"
    restart: unless-stopped
    volumes:
      - seaweedfs-volume:/data
    networks:
      - cryptogram
    depends_on:
      - seaweedmaster

  s3:
    image: chrislusf/seaweedfs
    command: 'filer -master="seaweedmaster:9333" -s3 -s3.config=/etc/seaweedfs/s3.json -s3.port=8333'
    restart: unless-stopped
    networks:
      cryptogram:
        aliases:
          - s3.local
    volumes:
      - ./s3_config/s3.json:/etc/seaweedfs/s3.json:ro
      - seaweedfs-buckets:/data
    depends_on:
      - seaweedmaster
      - seaweedvolume

  migrate-db:
    image: cryptogram/backend
    environment: 
      - PG_SU_PASSWORD=${PG_SU_PASSWORD}
      - PG_MEDIASOUP_PASSWORD=${PG_MEDIASOUP_PASSWORD}
      - PG_SU_NAME=postgres
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - S3_SECRET=${S3_SECRET}
      - DEPLOYMENT=${DEPLOYMENT}
      - BASE_URL=${BASE_URL}
    depends_on:
      - db
    networks:
      - cryptogram
    deploy:
      restart_policy:
        condition: on-failure
        delay: 2s
        max_attempts: 2
        window: 60s
    command: node /dist/migrateDb.js
    stop_grace_period: 1m

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile_dev_stage_1
    image: cryptogram/backend
    environment: 
      - DB_TYPE=writer
      - PG_PASSWORD=${PG_WRITER_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SECRET=${REDIS_SECRET}
      - REDIS_LEGACY_MODE=true
      - DEPLOYMENT=${DEPLOYMENT}
      - BASE_URL=${BASE_URL}
      - CGID_URL=${BASE_URL}/index_cgid.html
      - S3_SECRET=${S3_SECRET}
      - LOCAL_CERTIFICATE_IP=${LOCAL_CERTIFICATE_IP}
      - TWITTER_CALLBACK_URL=${TWITTER_CALLBACK_URL}
      - TWITTER_OAUTH2_CLIENT_ID=${TWITTER_OAUTH2_CLIENT_ID}
      - TWITTER_OAUTH2_CLIENT_SECRET=${TWITTER_OAUTH2_CLIENT_SECRET}
      - GOOGLE_RECAPTCHA_SECRET_KEY=${GOOGLE_RECAPTCHA_SECRET_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SUMSUB_SECRET_KEY=${SUMSUB_SECRET_KEY}
      - SUMSUB_APP_TOKEN=${SUMSUB_APP_TOKEN}
      # Bot settings: default permission for bots in channels (no_access, mentions_only, full_access, moderator)
      - BOT_DEFAULT_CHANNEL_PERMISSION=${BOT_DEFAULT_CHANNEL_PERMISSION:-mentions_only}
    depends_on:
      - db
      - redis-sessions
      - redis-socketio
      - redis-data
      - seaweedmaster
      - s3
      - memberlist
    networks:
      - cryptogram
    volumes:
      - "./vapid_keys.json:/run/secrets/vapid_keys_json:ro"
      - "./api_data:/api_data:ro"
    command: ["node", "/dist/api.js"]
    stop_grace_period: 1m
    restart: unless-stopped

  memberlist:
    image: cryptogram/backend
    environment: 
      - DB_TYPE=writer
      - PG_PASSWORD=${PG_WRITER_PASSWORD}
      - DEPLOYMENT=${DEPLOYMENT}
      - BASE_URL=${BASE_URL}
      - CGID_URL=${BASE_URL}/index_cgid.html
    depends_on:
      - db
    networks:
      - cryptogram
    command: ["node", "/dist/memberlist.js"]
    stop_grace_period: 1m
    restart: unless-stopped

  job-runner:
    image: cryptogram/backend
    environment: 
      - DB_TYPE=writer
      - PG_PASSWORD=${PG_WRITER_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SECRET=${REDIS_SECRET}
      - DEPLOYMENT=${DEPLOYMENT}
      - BASE_URL=${BASE_URL}
      - CGID_URL=${BASE_URL}/index_cgid.html
      - S3_SECRET=${S3_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
    depends_on:
      - db
      - redis-sessions
      - redis-socketio
      - redis-data
      - seaweedmaster
      - s3
    networks:
      - cryptogram
    command: ["node", "/dist/jobs.js"]
    stop_grace_period: 1m
    restart: unless-stopped

  mediasoup:
    image: cryptogram/backend
    environment: 
      - DB_TYPE=mediasoup
      - PG_PASSWORD=${PG_MEDIASOUP_PASSWORD}
      - DEPLOYMENT=${DEPLOYMENT}
      - HTTPS_CERT_FULLCHAIN=/dist/mediasoup/certs/nginx_certs/server-complete.pem
      - HTTPS_CERT_PRIVKEY=/dist/mediasoup/certs/nginx_certs/key.pem
      - MEDIASOUP_ANNOUNCED_IP=${MEDIASOUP_ANNOUNCED_IP}
      - DOMAIN=${MEDIASOUP_ANNOUNCED_IP}
      - DEBUG=mediasoup*
      - INTERACTIVE=false
      - LOCAL_CERTIFICATE_IP=${LOCAL_CERTIFICATE_IP}
      - MEDIASOUP_DISABLE_LIBURING=${MEDIASOUP_DISABLE_LIBURING}
    volumes:
      - "./nginx/certs:/dist/mediasoup/certs"
    networks:
      - cryptogram
    command: ["node", "/dist/mediasoup.js"]
    ports:
      - "${EXTERNAL_LISTEN_IP}:4443:4443/tcp"
      - "${EXTERNAL_LISTEN_IP}:40000-40099:40000-40099/udp"
    restart: "no"

  onchain:
    image: cryptogram/backend
    environment: 
      - DB_TYPE=writer
      - PG_PASSWORD=${PG_WRITER_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DEPLOYMENT=${DEPLOYMENT}
      - S3_SECRET=${S3_SECRET}
      - QUIKNODE_ETH=${QUIKNODE_ETH}
      - QUIKNODE_BSC=${QUIKNODE_BSC}
      - QUIKNODE_MATIC=${QUIKNODE_MATIC}
      - QUIKNODE_XDAI=${QUIKNODE_XDAI}
      - QUIKNODE_FANTOM=${QUIKNODE_FANTOM}
      - QUIKNODE_AVAX=${QUIKNODE_AVAX}
      - QUIKNODE_ARBITRUM=${QUIKNODE_ARBITRUM}
      - QUIKNODE_OPTIMISM=${QUIKNODE_OPTIMISM}
      - QUIKNODE_BASE=${QUIKNODE_BASE}
      - INFURA_LINEA=${INFURA_LINEA}
      - QUIKNODE_ARBITRUM_NOVA=${QUIKNODE_ARBITRUM_NOVA}
      - QUIKNODE_CELO=${QUIKNODE_CELO}
      - QUIKNODE_POLYGON_ZKEVM=${QUIKNODE_POLYGON_ZKEVM}
      - QUIKNODE_SCROLL=${QUIKNODE_SCROLL}
      - QUIKNODE_ZKSYNC=${QUIKNODE_ZKSYNC}
      - RECALCULATE_BALANCES_AND_ROLES=${RECALCULATE_BALANCES_AND_ROLES}
      - BASE_URL=${BASE_URL}
    depends_on:
      - db
      - redis-sessions
      - redis-socketio
      - redis-data
    networks:
      - cryptogram
    command: ["node", "/dist/onchain.js"]
    stop_grace_period: 1m
    restart: unless-stopped

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile_dev
      args:
        - NGINX_EXPOSED_ON=${LOCAL_CERTIFICATE_IP}
    ports:
      - ${EXTERNAL_LISTEN_IP}:8000:80
      - ${EXTERNAL_LISTEN_IP}:8001:443
    image: cryptogram/nginx
    depends_on:
      - api
    networks:
      - cryptogram
    restart: unless-stopped

  hardhat:
    build:
      context: ./hardhat
    image: cryptogram/hardhat
    command: npx hardhat node
    user: hardhat
    ports:
      - ${EXTERNAL_LISTEN_IP}:8545:8545
    networks:
      - cryptogram
    stop_grace_period: 5s
    restart: unless-stopped

  # llama:
  #   image: ghcr.io/ggml-org/llama.cpp:server-cuda-b5618
  #   command: >
  #     --hf-repo unsloth/Qwen3-4B-GGUF:q4_k_m
  #     --port 8000
  #     --threads 6
  #     --ctx-size 4096
  #     --flash-attn
  #     --batch-size 512
  #     --gpu-layers 999
  #     --host 0.0.0.0
  #     --cache-type-k q8_0
  #     --cache-type-v q8_0
  #     --jinja
  #     --reasoning-format deepseek
  #     --alias "Qwen3 4B"
  #     --api-key ${AI_API_KEY}
  #   environment:
  #     - HOME=/data
  #   networks:
  #     - cryptogram
  #   volumes:
  #     - ./llama/data:/data
  #   restart: unless-stopped
  #   user: "${BUILDER_UID}"

  # assistant:
  #   image: cryptogram/backend
  #   environment: 
  #     - DB_TYPE=writer
  #     - PG_PASSWORD=${PG_WRITER_PASSWORD}
  #     - REDIS_PASSWORD=${REDIS_PASSWORD}
  #     - REDIS_SECRET=${REDIS_SECRET}
  #     - DEPLOYMENT=${DEPLOYMENT}
  #     - BASE_URL=${BASE_URL}
  #     - CGID_URL=${BASE_URL}/index_cgid.html
  #     - AI_API_KEY=${AI_API_KEY}
  #   depends_on:
  #     - db
  #     - redis-socketio
  #     - redis-data
  #   networks:
  #     - cryptogram
  #   command: ["node", "/dist/assistant.js"]
  #   stop_grace_period: 1m
  #   restart: unless-stopped

  # pgadmin:
  #   container_name: pgadmin4_container
  #   image: dpage/pgadmin4:5.5
  #   restart: unless-stopped
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_SECRET}
  #     PGADMIN_LISTEN_PORT: 80
  #   ports:
  #     - 127.0.0.1:8080:80
  #   networks:
  #     - cryptogram
  #   volumes:
  #     - pgadmin-data:/var/lib/pgadmin

  # blockscout-db:
  #   image: postgres:14-alpine
  #   environment:
  #     - POSTGRES_DB=postgres
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=${PG_SU_PASSWORD}
  #   networks:
  #     - cryptogram
  #   shm_size: '256m'
  #   stop_signal: SIGINT
  #   stop_grace_period: 1m
  #   restart: unless-stopped

  # blockscout:
  #   depends_on:
  #     - blockscout-db
  #     - smart-contract-verifier
  #     - redis-blockscout
  #     - hardhat
  #   image: blockscout/blockscout:4.1.8
  #   container_name: 'blockscout'
  #   command: bash -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
  #   env_file:
  #     -  ./envs/common-blockscout.env
  #   environment:
  #     ETHEREUM_JSONRPC_VARIANT: 'hardhat'
  #     ETHEREUM_JSONRPC_HTTP_URL: http://hardhat:8545/
  #     ETHEREUM_JSONRPC_WS_URL: ws://hardhat:8545/
  #     INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: 'true'
  #     INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: 'true'
  #     DATABASE_URL: postgresql://postgres:${PG_SU_PASSWORD}@blockscout-db:5432/blockscout?ssl=false
  #     ECTO_USE_SSL: 'false'
  #     SECRET_KEY_BASE: '56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN'
  #     CHAIN_ID: '31337'
  #   ports:
  #     - 127.0.0.1:4000:4000
  #   #volumes:
  #     #- ./logs/:/app/logs/
  #   networks:
  #     - cryptogram
  #   restart: unless-stopped

  # smart-contract-verifier:
  #   image: ghcr.io/blockscout/smart-contract-verifier:${SMART_CONTRACT_VERIFIER_DOCKER_TAG:-latest}
  #   restart: unless-stopped
  #   container_name: 'smart-contract-verifier'
  #   env_file:
  #     -  ./envs/common-smart-contract-verifier.env
  #   ports:
  #     - 127.0.0.1:8043:8043
  #   networks:
  #     - cryptogram

  # visualizer:
  #   image: ghcr.io/blockscout/visualizer:${VISUALIZER_DOCKER_TAG:-latest}
  #   restart: unless-stopped
  #   container_name: 'visualizer'
  #   env_file:
  #     -  ./envs/common-visualizer.env
  #   ports:
  #     - 127.0.0.1:8050:8050
  #   networks:
  #     - cryptogram

  cg-builder:
    build:
      context: ./node20
      args:
        - BUILDER_UID=${BUILDER_UID}
        - BUILDER_GID=${BUILDER_GID}
    image: commonground/node20
    user: "${BUILDER_UID}:${BUILDER_GID}"
    environment:
      - PG_SU_PASSWORD=${PG_SU_PASSWORD}
      - PG_SU_NAME=postgres
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SECRET=${REDIS_SECRET}
      - REDIS_LEGACY_MODE=true
      - BASE_URL=${BASE_URL}
      - CGID_URL=${BASE_URL}/index_cgid.html
      - S3_SECRET=${S3_SECRET}
      - YARN_CACHE_FOLDER=/builder-cache
      - YARN_ENABLE_GLOBAL_CACHE=false
      - BUILDER_UID=${BUILDER_UID}
      - BUILDER_GID=${BUILDER_GID}
    restart: "no"
    volumes:
      - ../:/cg
      - builder-cache:/builder-cache
    networks:
      - cryptogram
    command: ["echo", "Not running interactive, exiting..."]

volumes:
  pgdata:
  pgadmin-data:
  seaweedfs-volume:
  seaweedfs-buckets:
  builder-cache:

networks:
  cryptogram:
    attachable: true