user nginx;
worker_processes auto;
pid /run/nginx.pid;

events {
	worker_connections 768;
	# multi_accept on;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;
	server_tokens off;

	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	#Accepting real IP from Cloudflare and Traefik (required for Matomo)
	set_real_ip_from	192.168.0.0/16;
	set_real_ip_from	172.16.0.0/12;
	set_real_ip_from	10.0.0.0/8;
	set_real_ip_from	173.245.48.0/20;
	set_real_ip_from	103.21.244.0/22;
	set_real_ip_from	103.22.200.0/22;
	set_real_ip_from	103.31.4.0/22;
	set_real_ip_from	141.101.64.0/18;
	set_real_ip_from	108.162.192.0/18;
	set_real_ip_from	190.93.240.0/20;
	set_real_ip_from	188.114.96.0/20;
	set_real_ip_from	197.234.240.0/22;
	set_real_ip_from	198.41.128.0/17;
	set_real_ip_from	162.158.0.0/15;
	set_real_ip_from	104.16.0.0/13;
	set_real_ip_from	104.24.0.0/14;
	set_real_ip_from	172.64.0.0/13;
	set_real_ip_from	131.0.72.0/22;
	real_ip_header		X-Forwarded-For;
	real_ip_recursive	on;

	##
	# Gzip Settings
	##

	gzip on;
	gzip_disable "msie6";

	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;

	# rate limiting for debugging purposes, units per second (<number>k/m/g)
	# limit_rate 50k;

	map $server_name $accesscontrol {
		default "*";
		"localhost" "*";
		"app.cg.local" "*";
		"{NGINX_EXPOSED_ON}" "*";
	}

	map $server_name $cg_csp {
		default "$cg_default_csp";
		"localhost" "$cg_default_csp connect-src 'self' ws://localhost:* wss://localhost:* http://localhost:* https://localhost:* http://127.0.0.1:8545 wss://www.walletlink.org wss://relay.walletconnect.com https://explorer-api.walletconnect.com https://verify.walletconnect.com https://cloudflare-eth.com https://testnet.fuel.network https://www.google.com https://mainnet.aeternity.io https://api.giphy.com https://pingback.giphy.com https://developer-access-mainnet.base.org https://rpc.gnosischain.com https://relay.farcaster.xyz https://mainnet.optimism.io https://api.sumsub.com https://*.g.alchemy.com;";
		"app.cg.local" "$cg_default_csp connect-src 'self' ws://app.cg.local:* wss://app.cg.local:* http://app.cg.local:* https://app.cg.local:* wss://www.walletlink.org wss://relay.walletconnect.com https://explorer-api.walletconnect.com https://verify.walletconnect.com https://cloudflare-eth.com https://testnet.fuel.network https://www.google.com https://mainnet.aeternity.io https://api.giphy.com https://pingback.giphy.com https://developer-access-mainnet.base.org https://rpc.gnosischain.com https://relay.farcaster.xyz https://mainnet.optimism.io https://api.sumsub.com https://*.g.alchemy.com;";
		"{NGINX_EXPOSED_ON}" "$cg_default_csp connect-src 'self' ws://{NGINX_EXPOSED_ON}:* wss://{NGINX_EXPOSED_ON}:* http://{NGINX_EXPOSED_ON}:* https://NGINX_EXPOSED_ON:* wss://www.walletlink.org wss://relay.walletconnect.com https://explorer-api.walletconnect.com https://verify.walletconnect.com https://cloudflare-eth.com https://testnet.fuel.network https://www.google.com https://mainnet.aeternity.io https://api.giphy.com https://pingback.giphy.com https://developer-access-mainnet.base.org https://rpc.gnosischain.com https://relay.farcaster.xyz https://mainnet.optimism.io https://api.sumsub.com https://*.g.alchemy.com;";
		"bs-local.com" "$cg_default_csp connect-src 'self' wss://bs-local.com:* https://bs-local.com:* wss://www.walletlink.org wss://relay.walletconnect.com https://explorer-api.walletconnect.com https://verify.walletconnect.com https://cloudflare-eth.com https://testnet.fuel.network https://www.google.com https://mainnet.aeternity.io https://api.giphy.com https://pingback.giphy.com https://developer-access-mainnet.base.org https://rpc.gnosischain.com https://relay.farcaster.xyz https://mainnet.optimism.io https://api.sumsub.com https://*.g.alchemy.com;";
	}

	server {
		listen 80;
		listen [::]:80;
		server_name localhost bs-local.com app.cg.local {NGINX_EXPOSED_ON};

		client_max_body_size 16M;

		set $cg_default_csp "default-src 'self'; frame-ancestors 'none'; script-src-elem 'self' 'unsafe-inline' https://static.cloudflareinsights.com https://www.google.com https://www.gstatic.com; frame-src *; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://use.typekit.net; font-src 'self' https://fonts.gstatic.com https://use.typekit.net; img-src 'self' data: blob: https://explorer-api.walletconnect.com https://ipfs.io https://media0.giphy.com https://media1.giphy.com https://media2.giphy.com https://media3.giphy.com https://media4.giphy.com;";

		location ~ "/files/([0-9a-f]+)/([0-9a-f]+)/([0-9]{8})T([0-9]{6})Z/([1-9][0-9]{1,6})$" {
			set $id "$1";
			set $signature "$2";
			set $date "$3";
			set $datetime "$3T$4Z";
			set $expires "$5";
			set $bucket "cg-media";
			set $s3url "http://s3.local:8333";

			proxy_redirect off;
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Host $host:8333;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto http;
			proxy_hide_header Set-Cookie;
			proxy_ignore_headers Set-Cookie;
			proxy_intercept_errors on;
			add_header Cache-Control "private,max-age=604800,immutable";
			add_header Access-Control-Allow-Origin $accesscontrol;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			rewrite /files/(.*) /$bucket/$id?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=cgadmin%2F$date%2Fglobal%2Fs3%2Faws4_request&X-Amz-Date=$datetime&X-Amz-Expires=$expires&X-Amz-Signature=$signature&X-Amz-SignedHeaders=host break;

			resolver 127.0.0.11 valid=10s ipv6=off;
			proxy_pass $s3url;
		}

		location ~ ^/api/v2/(Chat|Community|File|Message|User|Contract|Notification|Twitter|Lukso|CgId|Accounts|Sumsub|Plugins|Search|Report)/ {
			# config for api
			rewrite /api/v2/(.*) /$1 break;
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto http;
			add_header Cache-Control "no-cache";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(c|u|gated-videos|gated-files)/ {
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto http;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(sitemap\.xml|twitter-callback|twitter-login|verify-email|push-icon|token-sale|token|store)/?$ {
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}
		
		location /api/ws/ {
			proxy_pass http://wsapi:4000;
			proxy_redirect off;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(fonts|icons|images|static|audio|downloads)/ {
			root /www;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri =404;
		}

		location ~ ^/(index\.html|service-worker\.js|e/[^/]+)?$ {
			root /www;
			add_header Cache-Control "no-cache";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri /index.html;
		}

		location ~ ^/community/P0mI8SYrpO.* {
			rewrite ^ $scheme://$http_host/c/commonground/ permanent;
		}

		location ~ "^/community/(?<commurl>[a-zA-Z0-9]{10}).*" {
			rewrite ^ $scheme://$http_host/c/$commurl/ permanent;
		}

		location ~ "^/index_cgid.html/?$" {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files /index_cgid.html =404;
		}

		location /enable-cross-origin-security {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			add_header Cross-Origin-Opener-Policy "same-origin";
			add_header Cross-Origin-Embedder-Policy "require-corp";
			include /etc/nginx/mime.types;
			try_files /index.html =404;
		}

		location /disable-cross-origin-security {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files /index.html =404;
		}

		location / {
			root /www;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri =404;
		}
	}

	server {
		listen 443 ssl;
		listen [::]:443 ssl;
		server_name localhost bs-local.com app.cg.local {NGINX_EXPOSED_ON};

		ssl_certificate /etc/nginx/keys/server.crt;
		ssl_certificate_key /etc/nginx/keys/server.key;

		client_max_body_size 16M;

		set $cg_default_csp "default-src 'self'; frame-ancestors 'none'; script-src-elem 'self' https://static.cloudflareinsights.com https://www.google.com https://www.gstatic.com; frame-src *; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://use.typekit.net; font-src 'self' https://fonts.gstatic.com https://use.typekit.net; img-src 'self' data: blob: https://explorer-api.walletconnect.com https://ipfs.io https://media0.giphy.com https://media1.giphy.com https://media2.giphy.com https://media3.giphy.com https://media4.giphy.com;";

		add_header X-Frame-Options DENY always;
		add_header X-Content-Type-Options nosniff always;
		add_header Content-Security-Policy "$cg_csp" always;

		location ~ "/files/([0-9a-f]+)/([0-9a-f]+)/([0-9]{8})T([0-9]{6})Z/([1-9][0-9]{1,6})$" {
			set $id "$1";
			set $signature "$2";
			set $date "$3";
			set $datetime "$3T$4Z";
			set $expires "$5";
			set $bucket "cg-media";
			set $s3url "http://s3.local:8333";

			proxy_redirect off;
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Host $host:8333;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			proxy_hide_header Set-Cookie;
			proxy_ignore_headers Set-Cookie;
			proxy_intercept_errors on;
			add_header Cache-Control "private,max-age=604800,immutable";
			add_header Access-Control-Allow-Origin $accesscontrol;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			rewrite /files/(.*) /$bucket/$id?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=cgadmin%2F$date%2Fglobal%2Fs3%2Faws4_request&X-Amz-Date=$datetime&X-Amz-Expires=$expires&X-Amz-Signature=$signature&X-Amz-SignedHeaders=host break;

			resolver 127.0.0.11 valid=10s ipv6=off;
			proxy_pass $s3url;
		}

		location ~ ^/api/v2/(Chat|Community|File|Message|User|Contract|Notification|Twitter|Lukso|CgId|Accounts|Sumsub|Plugins|Search|Report)/ {
			# config for api
			rewrite /api/v2/(.*) /$1 break;
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			add_header Cache-Control "no-cache";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(c|u|gated-videos|gated-files)/ {
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(sitemap\.xml|twitter-callback|twitter-login|verify-email|push-icon|token-sale|token|store)/?$ {
			proxy_pass http://api:4000;
			proxy_redirect off;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto https;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location /api/ws/ {
			proxy_pass http://wsapi:4000;
			proxy_redirect off;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			proxy_pass_request_headers on;
		}

		location ~ ^/(fonts|icons|images|static|audio|downloads)/ {
			root /www;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri =404;
		}

		location ~ ^/(index\.html|service-worker\.js|e/[^/]+)?$ {
			root /www;
			add_header Cache-Control "no-cache";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri /index.html;
		}

		location ~ ^/community/P0mI8SYrpO.* {
			rewrite ^ $scheme://$http_host/c/commonground/ permanent;
		}

		location ~ "^/community/(?<commurl>[a-zA-Z0-9]{10}).*" {
			rewrite ^ $scheme://$http_host/c/$commurl/ permanent;
		}

		location ~ "^/index_cgid.html/?$" {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files /index_cgid.html =404;
		}

		location /enable-cross-origin-security {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			add_header Cross-Origin-Opener-Policy "same-origin";
			add_header Cross-Origin-Embedder-Policy "require-corp";
			include /etc/nginx/mime.types;
			try_files /index.html =404;
		}

		location /disable-cross-origin-security {
			root /www;
			add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files /index.html =404;
		}

		location / {
			root /www;
			add_header Cache-Control "private,max-age=86400,must-revalidate";
			add_header X-Frame-Options DENY;
			add_header X-Content-Type-Options nosniff;
			add_header Content-Security-Policy "$cg_csp";
			include /etc/nginx/mime.types;
			try_files $uri =404;
		}
	}
}